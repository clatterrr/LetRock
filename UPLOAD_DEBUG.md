# 文件上传调试指南

## 问题描述

您遇到了上传失败的问题，错误信息显示：
```
上传失败: Unexpected token 'R', "Request En"... is not valid JSON
```

## 解决方案

### ✅ 已完成的修复

1. **改进了错误处理**
   - 添加了详细的控制台日志
   - 改进了错误信息显示
   - 添加了 JSON 解析错误处理

2. **实现了客户端直接上传**
   - 创建了 `api/get-upload-url.js` 生成上传签名
   - 修改了前端代码，直接上传到腾讯云 COS
   - 避免了 Vercel 的文件上传限制

3. **添加了进度显示**
   - 每个文件独立的进度条
   - 详细的错误状态显示
   - 实时上传状态更新

## 调试步骤

### 1. 打开浏览器开发者工具

1. 按 `F12` 打开开发者工具
2. 切换到 `Console` 标签
3. 切换到 `Network` 标签

### 2. 尝试上传文件

1. 点击"上传文件"按钮
2. 选择一个或多个文件
3. 观察控制台输出

### 3. 查看详细日志

控制台会显示以下信息：

```
🚀 开始上传文件... 2 个文件
📤 上传文件 1/2: example.mp4
📡 获取上传URL响应: 200
✅ 获取上传URL成功: {success: true, uploadUrl: "...", key: "..."}
📤 开始上传到腾讯云...
📡 腾讯云上传响应: 200
✅ 文件上传成功: example.mp4
```

### 4. 检查网络请求

在 `Network` 标签中查看：
- `/api/get-upload-url` 请求
- 腾讯云上传请求
- 响应状态和内容

## 常见问题

### 问题 1: 获取上传URL失败

**可能原因**：
- 环境变量未配置
- 腾讯云配置错误
- API 路由问题

**解决方法**：
1. 检查 Vercel 控制台中的环境变量
2. 确保设置了 `COS_SECRET_ID`、`COS_SECRET_KEY` 等
3. 重新部署项目

### 问题 2: 腾讯云上传失败

**可能原因**：
- 签名URL过期
- 文件类型不支持
- 网络问题

**解决方法**：
1. 检查文件类型是否支持
2. 重试上传
3. 检查网络连接

### 问题 3: 进度条不更新

**可能原因**：
- JavaScript 错误
- DOM 元素不存在

**解决方法**：
1. 检查控制台错误
2. 刷新页面重试

## 环境变量检查

确保在 Vercel 控制台中设置了以下环境变量：

```env
COS_SECRET_ID=您的腾讯云SecretId
COS_SECRET_KEY=您的腾讯云SecretKey
COS_BUCKET=您的存储桶名称
COS_REGION=您的存储桶地域
ZHAOLI_API_KEY=您的zhaoli API key
ZHAOLI_API_SECRET=您的zhaoli API secret
```

## 测试步骤

1. **部署项目**：
   ```bash
   vercel --prod
   ```

2. **测试基本功能**：
   - 访问 `https://theme7-beta.vercel.app/api/ping`
   - 确保返回 `{"pong": true}`

3. **测试上传功能**：
   - 打开网页
   - 尝试上传小文件（< 1MB）
   - 查看控制台日志

4. **检查文件列表**：
   - 上传成功后刷新文件列表
   - 确认文件出现在列表中

## 如果问题仍然存在

请提供以下信息：

1. **控制台日志**：复制完整的控制台输出
2. **网络请求**：Network 标签中的请求详情
3. **错误截图**：错误弹窗的截图
4. **环境变量**：Vercel 控制台中的环境变量配置

## 联系支持

如果问题仍然存在，请：
1. 运行 `vercel logs` 查看服务器日志
2. 检查 Vercel 控制台中的 Functions 状态
3. 提供详细的错误信息和日志 